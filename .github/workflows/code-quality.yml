name: Code Quality and Break Prevention

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  prevent-code-breaks:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: Check for emojis in code
      run: |
        echo "Checking for emojis in repository..."
        if git grep -P '[\x{1F600}-\x{1F64F}]|[\x{1F300}-\x{1F5FF}]|[\x{1F680}-\x{1F6FF}]|[\x{1F1E0}-\x{1F1FF}]|[\x{2600}-\x{26FF}]|[\x{2700}-\x{27BF}]' .; then
          echo "ERROR: Emojis found in repository. Please remove all emojis before proceeding."
          exit 1
        else
          echo "SUCCESS: No emojis found in repository."
        fi
    
    - name: Check for TODO/FIXME comments
      run: |
        echo "Checking for TODO/FIXME comments..."
        TODO_COUNT=$(git grep -i -c "TODO\|FIXME\|HACK\|XXX" . 2>/dev/null || echo "0")
        if [ "$TODO_COUNT" -gt 5 ]; then
          echo "WARNING: Found $TODO_COUNT TODO/FIXME comments. Please address them before merging."
        fi
    
    - name: Validate Maven build
      run: |
        echo "Validating Maven build..."
        mvn clean validate -DskipTests -q
        if [ $? -ne 0 ]; then
          echo "ERROR: Maven validation failed. Build is broken."
          exit 1
        fi
    
    - name: Check for compilation errors
      run: |
        echo "Checking for compilation errors..."
        mvn compile -DskipTests -q
        if [ $? -ne 0 ]; then
          echo "ERROR: Compilation failed. Code is broken."
          exit 1
        fi
    
    - name: Run all unit tests
      run: |
        echo "Running unit tests..."
        mvn test -q
        if [ $? -ne 0 ]; then
          echo "ERROR: Unit tests failed. Code is broken."
          exit 1
        fi
    
    - name: Check test coverage
      run: |
        echo "Checking test coverage..."
        mvn jacoco:report -q
        COVERAGE=$(mvn jacoco:report -q | grep -o 'Total.*[0-9]\+%' | grep -o '[0-9]\+')
        if [ "$COVERAGE" -lt 80 ]; then
          echo "ERROR: Test coverage ($COVERAGE%) is below 80%. Please add more tests."
          exit 1
        fi
    
    - name: Check for security vulnerabilities
      run: |
        echo "Checking for security vulnerabilities..."
        mvn org.owasp:dependency-check-maven:check -q
        if [ $? -ne 0 ]; then
          echo "ERROR: Security vulnerabilities found. Please fix them before proceeding."
          exit 1
        fi
    
    - name: Check code quality
      run: |
        echo "Checking code quality..."
        mvn spotbugs:check -q
        if [ $? -ne 0 ]; then
          echo "ERROR: Code quality issues found. Please fix them before proceeding."
          exit 1
        fi
    
    - name: Validate configuration files
      run: |
        echo "Validating configuration files..."
        find . -name "*.yml" -o -name "*.yaml" -o -name "*.json" | xargs -I {} sh -c 'echo "Validating {}" && python3 -c "import json, yaml; yaml.safe_load(open("{}"))" 2>/dev/null || echo "ERROR: Invalid YAML/JSON in {}"'
    
    - name: Check for hardcoded secrets
      run: |
        echo "Checking for hardcoded secrets..."
        if git grep -i -E "password|secret|key|token" --include="*.java" --include="*.yml" --include="*.yaml" --include="*.properties" . | grep -v "password.*example\|secret.*example\|key.*example\|token.*example"; then
          echo "WARNING: Potential hardcoded secrets found. Please review and use environment variables."
        fi
    
    - name: Check for console.log statements
      run: |
        echo "Checking for console.log statements..."
        if git grep -r "console.log" --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" .; then
          echo "WARNING: console.log statements found. Please remove them before production."
        fi
    
    - name: Validate API endpoints
      run: |
        echo "Validating API endpoints..."
        find . -name "*Controller.java" -exec grep -l "@RestController" {} \; | while read controller; do
          echo "Validating $controller..."
          if grep -q "@.*Mapping" "$controller"; then
            echo "API mappings found in $controller"
          else
            echo "WARNING: No API mappings found in $controller"
          fi
        done
    
    - name: Check database migrations
      run: |
        echo "Checking database migrations..."
        if [ -d "src/main/resources/db/migration" ]; then
          MIGRATION_COUNT=$(find src/main/resources/db/migration -name "*.sql" | wc -l)
          echo "Found $MIGRATION_COUNT database migration files"
          if [ "$MIGRATION_COUNT" -eq 0 ]; then
            echo "WARNING: No database migrations found"
          fi
        fi
    
    - name: Final validation
      run: |
        echo "All validations passed! Repository is ready for deployment."
        echo "Summary:"
        echo "- No emojis found"
        echo "- No compilation errors"
        echo "- All tests passing"
        echo "- Test coverage >= 80%"
        echo "- No security vulnerabilities"
        echo "- Code quality checks passed"
